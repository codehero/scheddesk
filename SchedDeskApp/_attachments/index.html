<!DOCTYPE html>
<html>
	<head>
		<title>Schedule Desktop</title>
		<link type="text/css" href="style/jquery.ui.css" rel="stylesheet"/>
		<link type="text/css" href="style/jquery-ui-timepicker-addon.css" rel="stylesheet"/>
  	<script src="vendor/couchapp/loader.js"></script>
		<script type="text/javascript" src="script/jquery.ui.js"></script>
		<script type="text/javascript" src="script/scheddesk.js"></script>
		<script type="text/javascript" src="script/jquery-ui-timepicker-addon.js"></script>

		<script type="text/javascript">
			/* Get the DB name. */
			var urlParts = document.URL.split("/");
			var DB_NAME = urlParts[3];

			function dataLink(id, text){
				return "<a target=\"_blank\" href=\"/_utils/document.html?"+
					DB_NAME +"/"+ id +"\">"+ text +"</a>";
			}

			$(document).ready(function() {
				$("#tabDiv").tabs();

				$("#startTime").datetimepicker();
				$("#endTime").datetimepicker();

				/* Populate Task Definitions. */
				$.couch.app(function(app) {
					var db = $.couch.db(DB_NAME);
					db.view("SchedDeskApp/Tasks",
						{
							"success": function(data, textStatus){
								var tbody = $("#taskTableBody").empty();

								function genTrigger(id){
									return function(){
										var now = new Date().getTime();
										var tdoc = {
											"_id" : "scheddesk.manualTrigger." + now,
											"scheddesk_trigger":{
												"timestamp" : now,
												"taskDefinition" : id,
												"scheduledTime" : -1
											},
										};

										db.saveDoc(tdoc, {
											"success":function(data, textStatus){
												alert("Enqueued trigger: " + tdoc._id);
											}
										});
									}
								}

								for(var i = 0; i < data.rows.length; ++i){
									var row = [
										data.rows[i].key,
										(data.rows[i].value.length == 0) ?
											"<input type=\"button\" value=\"Initiate\"/>" : "---",
										dataLink(data.rows[i].id, "Go")
									];

									row = $("<tr><td>"+ row.join("</td><td>") +"</td></tr>");
									row.find("input").click(genTrigger(data.rows[i].id));
									tbody.append(row);
								}
							}
						}
					);

					/* Show uncompleted tasks. */
					db.list("SchedDeskApp/StateQuery", "SchedDeskApp/State",
						{
							"op":"lt",
							"preMask" : "0xF",
							"maskValue":"0x8",
							"group" : true,
							"success": function(data, textStatus){
								var tbody = $("#taskListingBody").empty();
								for(var i = 0; i < data.length; ++i){
									var e = data[i];
									var ts = e.value.ts < 0 ?
										"Immediate" : scheddeskFormatDate(new Date(e.value.ts));

									var cause = e.value.cause;
									if(!e.value.cause){
										var id = e.value._id;
										if(-1 != id.indexOf("timedTrigger")){
											cause = "Scheduled";
										}
										else if(-1 != id.indexOf("manualTrigger")){
											cause = "Manual";
										}
										else if(-1 != id.indexOf("retryTrigger")){
											cause = "Retry";
										}
										else {
											/* Assume cascade trigger. */
											cause = "Cascade";
										}
									}

									var row = [
										taskStateStrings[e.value.mask],
										cause,
										ts,
										dataLink(e.value._id, e.value._id)
									];
									row = $("<tr><td>"+ row.join("</td><td>") +"</td></tr>");

									tbody.append(row);
								}
							}
						}
					);

					/* Show open errors. */
					db.list("SchedDeskApp/StateQuery", "SchedDeskApp/State",
						{
							"op":"eq",
							"preMask" : "0xF",
							"maskValue":"0x7",
							"group" : true,
							"success": function(data, textStatus){
								var tbody = $("#errorTableBody").empty();
								for(var i = 0; i < data.length; ++i){

									var e = data[i];
									var ts = e.value.ts < 0 ?
										"Immediate" : scheddeskFormatDate(new Date(e.value.ts));

									function genTrigger(triggerID,x){
										return function(){

											db.getDoc(x, function(){

												var now = new Date().getTime();
												var tdoc = {
													 "_id": "scheddesk.retryTrigger." + now,
													 "scheddesk_trigger": {
															 "retryTriggerID": triggerID,
															 "retryDequeueID": dequeueID,
															 "timestamp": now,
															 "taskDefinition": "scheddesk.retry",
															 "scheduledTime": -1
													 }
												}
											});
										};
									}

									var row = [
										ts,
										e.value._id,
										dataLink(e.key, "Go"),
										dataLink(e.value._id, "Go"),
										"<input type=\"button\" value=\"Initiate\"/>"
									];
									row = $("<tr><td>"+ row.join("</td><td>") +"</td></tr>");

									row.find("input").click(genTrigger(e.value._id));
									tbody.append(row);
								}
							}
						}
					);

					/*  */
					$("#doLogQuery").click(function(){
						try{
							var start = new Date($("#startTime").val()).getTime();
							var end = new Date($("#endTime").val()).getTime();
							if(end < start)
								throw new Error("End time must be after start time!");

							db.view("SchedDeskApp/Queue",
								{
									"startkey":[start, null],
									"endkey":[end, null],
									"include_docs":true,
									"success": function(data, textStatus){
										var tbody = $("#logTableBody").empty();
										for(var i = 0; i < data.rows.length; ++i){
											var d = scheddeskFormatDate(new Date(data.rows[i].key[0]));

											var row = [
												d,
												dataLink(data.rows[i].key[1], data.rows[i].key[1]),
												dataLink(data.rows[i].id, data.rows[i].id)
											];
											row = $("<tr><td>"+ row.join("</td><td>") +"</td></tr>");
											tbody.append(row);
										}
									}
								}
							);
						}
						catch(e){
							alert(e.message);
						}
					});

				});

			});
		</script>
	</head>

	<body>
		<div id="tabDiv">
			<ul>
				<li><a href="#taskDefTab"><span>Task Definitions</span></a></li>
				<li><a href="#taskListingTab"><span>Task Listing</span></a></li>
				<li><a href="#scheduleTab"><span>Routine Schedule</span></a></li>
				<li><a href="#logTab"><span>Log</span></a></li>
				<li><a href="#errorTab"><span>Unresolved Errors</span></a></li>
			</ul>

			<div id="taskDefTab">
				<table border="1">
					<thead>
						<th>Task Name</th>
						<th>Action</th>
						<th>Details</th>
					</thead>
					<tbody id="taskTableBody"></tbody>
				</table>
			</div>

			<div id="taskListingTab">
				<table border="1">
					<thead>
						<th>State</th>
						<th>Cause</th>
						<th>Scheduled Time</th>
						<th>Trigger ID</th>
					</thead>
					<tbody id="taskListingBody"></tbody>
				</table>
			</div>

			<div id="scheduleTab">
				<h1>TODO</h1>
			</div>

			<div id="logTab">
				<table>
					<tbody>
						<tr>
							<td>Search Range Start</td>
							<td><input id="startTime" type="text"/></td>
						</tr>
						<tr>
							<td>Search Range End</td>
							<td><input id="endTime" type="text"/></td>
						</tr>
						<tr>
							<td><input id="doLogQuery" type="button" value="Retrieve Times"/></td>
						</tr>
					</tbody>
				</table>

				<table border="1">
					<thead>
						<th>Timestamp</th>
						<th>Trigger ID</th>
						<th>Event ID</th>
					</thead>
					<tbody id="logTableBody"></tbody>
				</table>

			</div>

			<div id="errorTab">
				<table border="1">
					<thead>
						<th>Timestamp</th>
						<th>Trigger ID</th>
						<th>Trigger Details</th>
						<th>Error Details</th>
						<th>Retry</th>
					</thead>
					<tbody id="errorTableBody"></tbody>
				</table>
			</div>

		</div>
	</body>
</html>
